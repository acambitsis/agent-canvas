<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Allowlist Management</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container" style="min-height: 100vh; padding: 40px 20px;">
        <div style="max-width: 900px; margin: 0 auto;">
            <!-- Header -->
            <div class="surface-card" style="margin-bottom: 30px;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <h1 style="margin: 0 0 8px 0; color: var(--brand-primary);">Allowlist Management</h1>
                        <p style="margin: 0; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                            Manage user access to AgentCanvas
                        </p>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <a href="/" class="btn btn-glass" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                            <i data-lucide="arrow-left"></i>
                            <span>Back to App</span>
                        </a>
                        <button type="button" class="btn btn-glass" id="refreshBtn" title="Refresh list">
                            <i data-lucide="refresh-cw"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Email Form -->
            <div class="surface-card" style="margin-bottom: 30px;">
                <h2 style="margin: 0 0 20px 0; color: rgba(255, 255, 255, 0.9); font-size: 20px;">Add Email to Allowlist</h2>
                <form id="addEmailForm" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex: 1; min-width: 250px;">
                        <label for="newEmail" style="display: block; margin-bottom: 8px; color: rgba(255, 255, 255, 0.9); font-size: 14px;">
                            Email Address
                        </label>
                        <input 
                            type="email" 
                            id="newEmail" 
                            name="email" 
                            required 
                            autocomplete="email"
                            style="width: 100%; padding: 12px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; box-sizing: border-box;"
                            placeholder="user@example.com"
                        >
                    </div>
                    <button 
                        type="submit" 
                        class="btn btn-glass"
                        style="padding: 12px 24px; font-weight: 600; white-space: nowrap;"
                        id="addEmailBtn"
                    >
                        <i data-lucide="plus"></i>
                        <span>Add Email</span>
                    </button>
                </form>
                <div id="addMessage" style="margin-top: 16px; padding: 12px; border-radius: 6px; display: none;"></div>
            </div>

            <!-- Email List -->
            <div class="surface-card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="margin: 0; color: rgba(255, 255, 255, 0.9); font-size: 20px;">
                        Allowed Emails (<span id="emailCount">0</span>)
                    </h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input 
                            type="search" 
                            id="searchInput" 
                            placeholder="Search emails..."
                            style="padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.2); background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 14px; min-width: 200px;"
                        >
                    </div>
                </div>

                <div id="loadingMessage" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                    <i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i>
                    <p style="margin-top: 12px;">Loading allowlist...</p>
                </div>

                <div id="errorMessage" style="display: none; padding: 20px; background: rgba(220, 53, 69, 0.2); border: 1px solid rgba(220, 53, 69, 0.5); border-radius: 6px; color: #ff6b6b; margin-bottom: 20px;"></div>

                <div id="emailList" style="display: none;">
                    <!-- Email items will be inserted here -->
                </div>

                <div id="emptyMessage" style="display: none; text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                    <i data-lucide="inbox" style="opacity: 0.5;"></i>
                    <p style="margin-top: 12px;">No emails in allowlist</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .email-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }

        .email-item:last-child {
            border-bottom: none;
        }

        .email-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .email-info {
            flex: 1;
            min-width: 0;
        }

        .email-address {
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 4px;
            word-break: break-all;
        }

        .email-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .email-source {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .email-source.env {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .email-source.kv {
            background: rgba(23, 162, 184, 0.2);
            color: #17a2b8;
        }

        .email-source.both {
            background: rgba(108, 117, 125, 0.2);
            color: #adb5bd;
        }

        .email-actions {
            display: flex;
            gap: 8px;
            margin-left: 16px;
        }

        .btn-remove {
            padding: 8px 12px;
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #ff6b6b;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-remove:hover:not(:disabled) {
            background: rgba(220, 53, 69, 0.3);
            border-color: rgba(220, 53, 69, 0.7);
        }

        .btn-remove:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-remove.env-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
        }

        .btn-remove.env-disabled::after {
            content: 'Cannot remove env var emails';
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 4px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .btn-remove.env-disabled:hover::after {
            opacity: 1;
        }
    </style>

    <script>
        let allEmails = [];

        // Initialize Lucide icons
        lucide.createIcons();

        // Load allowlist on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAllowlist();
            
            // Setup form handler
            document.getElementById('addEmailForm').addEventListener('submit', handleAddEmail);
            
            // Setup refresh button
            document.getElementById('refreshBtn').addEventListener('click', () => {
                loadAllowlist();
            });

            // Setup search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterEmails(e.target.value);
            });
        });

        async function loadAllowlist() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const emailList = document.getElementById('emailList');
            const emptyMessage = document.getElementById('emptyMessage');
            const emailCount = document.getElementById('emailCount');

            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            emailList.style.display = 'none';
            emptyMessage.style.display = 'none';

            try {
                const response = await fetch('/api/admin/allowlist');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load allowlist');
                }

                allEmails = data.emails || [];
                emailCount.textContent = allEmails.length;

                if (allEmails.length === 0) {
                    emptyMessage.style.display = 'block';
                } else {
                    renderEmailList(allEmails);
                    emailList.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading allowlist:', error);
                errorMessage.textContent = error.message || 'Failed to load allowlist. Please refresh the page.';
                errorMessage.style.display = 'block';
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        function renderEmailList(emails) {
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '';

            emails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'email-item';
                
                const source = email.source || 'kv';
                const canRemove = source !== 'env';

                item.innerHTML = `
                    <div class="email-info">
                        <div class="email-address">${escapeHtml(email.email)}</div>
                        <div class="email-meta">
                            <span class="email-source ${source}">
                                ${source === 'env' ? 'Environment Variable' : source === 'both' ? 'Both' : 'KV Storage'}
                            </span>
                            ${email.addedAt ? `<span>Added: ${formatDate(email.addedAt)}</span>` : ''}
                            ${email.addedBy && email.addedBy !== 'system' ? `<span>By: ${escapeHtml(email.addedBy)}</span>` : ''}
                        </div>
                    </div>
                    <div class="email-actions">
                        ${canRemove ? `
                            <button 
                                type="button" 
                                class="btn-remove" 
                                onclick="handleRemoveEmail('${escapeHtml(email.email)}')"
                                title="Remove from allowlist"
                            >
                                <i data-lucide="trash-2"></i>
                                <span>Remove</span>
                            </button>
                        ` : `
                            <button 
                                type="button" 
                                class="btn-remove env-disabled" 
                                disabled
                                title="Cannot remove emails from environment variable allowlist"
                            >
                                <i data-lucide="lock"></i>
                                <span>Locked</span>
                            </button>
                        `}
                    </div>
                `;
                
                emailList.appendChild(item);
            });

            // Reinitialize icons
            lucide.createIcons();
        }

        function filterEmails(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) {
                renderEmailList(allEmails);
                return;
            }

            const filtered = allEmails.filter(email => 
                email.email.toLowerCase().includes(term) ||
                (email.addedBy && email.addedBy.toLowerCase().includes(term))
            );
            
            renderEmailList(filtered);
        }

        async function handleAddEmail(e) {
            e.preventDefault();
            
            const emailInput = document.getElementById('newEmail');
            const addBtn = document.getElementById('addEmailBtn');
            const messageDiv = document.getElementById('addMessage');
            
            const email = emailInput.value.trim();
            if (!email) {
                showMessage(messageDiv, 'Please enter an email address', true);
                return;
            }

            addBtn.disabled = true;
            addBtn.innerHTML = '<i data-lucide="loader-2" style="animation: spin 1s linear infinite;"></i><span>Adding...</span>';
            lucide.createIcons();
            hideMessage(messageDiv);

            try {
                const response = await fetch('/api/admin/allowlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showMessage(messageDiv, `Email "${email}" added successfully`, false);
                    emailInput.value = '';
                    // Reload the list
                    await loadAllowlist();
                    // Clear search
                    document.getElementById('searchInput').value = '';
                } else {
                    showMessage(messageDiv, data.error || 'Failed to add email', true);
                }
            } catch (error) {
                console.error('Error adding email:', error);
                showMessage(messageDiv, 'An error occurred. Please try again.', true);
            } finally {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i data-lucide="plus"></i><span>Add Email</span>';
                lucide.createIcons();
            }
        }

        async function handleRemoveEmail(email) {
            if (!confirm(`Are you sure you want to remove "${email}" from the allowlist?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/allowlist?email=${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Reload the list
                    await loadAllowlist();
                    // Clear search
                    document.getElementById('searchInput').value = '';
                } else {
                    alert(data.error || 'Failed to remove email');
                }
            } catch (error) {
                console.error('Error removing email:', error);
                alert('An error occurred. Please try again.');
            }
        }

        function showMessage(element, text, isError) {
            element.textContent = text;
            element.style.display = 'block';
            element.style.background = isError 
                ? 'rgba(220, 53, 69, 0.2)' 
                : 'rgba(23, 162, 184, 0.2)';
            element.style.color = isError ? '#ff6b6b' : '#17a2b8';
            element.style.border = `1px solid ${isError ? '#ff6b6b' : '#17a2b8'}`;
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>


